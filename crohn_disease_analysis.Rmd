---
title: "Crohn's Disease Adverse Events Data Analysis"
author: "Gallardo-GÃ³mez, D."
date: '2024-10-24'
output: html_document
---

### Load required libraries

```{r, message=FALSE, warning=FALSE, results='hide'}
library(tidyverse)
library(brms)
library(marginaleffects)
library(ggthemes)
library(ggsci)
library(tidybayes)
```


## Brief EDA

First, we imported the dataset that we are going to use in our analysis. This data were taken from the `Rdatasets` package, which is a collection of 2337 datasets which were originally distributed alongside the statistical software environment `R` and some of its add-on packages.
Specifically, these data correspond to the **National Cooperative Cronh's Disease Study (NCCDS)**, where **prednisone** and **sulfasalazine** were evaluated to assess their effectiveness against placebo in managing Crohn's Disease (CD) symptoms.

```{r, message=FALSE, results='hide', warning=FALSE, echo=FALSE}
CrohnD <- read_csv(paste(getwd(), "/CrohnD.csv", sep = ""))
```


Variables explanation:

  + `ID`: patient identifier.
  + `nrAdvE`: number of adverse events.
  + `BMI`: body mass index.
  + `height`: in cm.
  + `country`: a factor with levels `0`and `1`.
  + `sex`: the person's gender, a binary factor with levels `M`and `F`.
  + `age`: in years.
  + `weight`: in kilograms.
  + `treat`: how CD was treated; `0` = `placebo`, `1` = `prednisone`, and `2` = `sulfasalazine`.
  
```{r}
head(CrohnD)
```

The distribution of our target could be fitted with a `skew_normal()`; however, a `poisson` distribution possibly better fits it. Anyway, at the end of this analysis we'll provide advises on *how to model different types of adverse events data*, depending on how these data were collected.

```{r, echo=FALSE}
CrohnD %>%
  ggplot(aes(nrAdvE)) +
  geom_histogram(binwidth = 1, fill = "grey70", col = "black") +
  theme_minimal() +
  labs(x = "Number of adverse events", y = "Count") +
  scale_x_continuous(breaks = seq(0, 12, 1)) +
  scale_y_continuous(breaks = seq(0, 50, 5))
```


## Model fitting

As we are interested in which treatment is the most effective to reduce adverse events in people with CD, we are going to fit two Bayesian multilevel models: (1) using a `skew_normal()` distribution, and (2) using a *Poisson* distribution.

```{r, message=FALSE, results='hide', warning=FALSE}
# model applying skew_normal()
mod_1 <- brm(nrAdvE ~ 1 + BMI + sex + age + treat + (1 | ID),
             data = CrohnD,
             family = skew_normal(),
             chains = 4,
             iter = 3000,
             seed = 23102024)

# model using a Poisson distribution
mod_2 <- brm(nrAdvE ~ 1 + BMI + sex + age + treat + (1 | ID),
             data = CrohnD,
             family = "poisson",
             chains = 4,
             iter = 3000,
             seed = 24102024)
```


Let's compare both predictive posterior checks to compare what model better fits the observed data.

#### Posterior predictive checking

```{r, echo=FALSE, results='hide', message=FALSE}
# libraries for plot wrangling
library(cowplot)
library(patchwork)

# posterior predictive checks
pp_mod_1 <- (pp_check(mod_1, ndraws = 150) + ggtitle("Model 1 using skew_normal()") + theme_minimal_grid())

pp_mod_2 <- (pp_check(mod_2, ndraws = 150) + ggtitle("Model 2 using Poisson distribution") + theme_minimal_grid())
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.height=6, fig.width=8}
pp_mod_1 + pp_mod_2
```


Although both models fitted well the observed data, it seems that the *Poisson* distribution does a really good work even better than our first model.


## Predictive modelling

We are going to use our model to predict the number of adverse events adjusting by sex, age, BMI, and received treatment.

```{r}
# we are going to save the predictions in an object
pred <- marginaleffects::predictions(mod_2,
                    newdata = datagrid(BMI = seq(20, 30, 1),
                                       sex = unique(CrohnD$sex),
                                       age = seq(30, 70, 1),
                                       treat = unique(CrohnD$treat))) %>%
  posteriordraws()
```


Next, we plotted the predictions in order to observe how the number of adverse events vary across age and BMI to identify potential risk factors for CD.

```{r, echo=FALSE}
p <- pred %>%
  
  # a bit of data wrangling
  filter(draw < 18) %>% # removing potential outliers
  mutate(treat = case_when(
    treat == "placebo" ~ "Placebo",
    treat == "d1" ~ "Prednisone",
    treat == "d2" ~ "Sulfasalazine"
  ), # treatments' names customization
  treat = factor(treat,
                 levels = c("Prednisone",
                                   "Sulfasalazine",
                                   "Placebo")),
  sex = ifelse(sex == "F", "Females", "Males")) %>%
  
  # plot!
  ggplot(aes(x = age, y = BMI)) +
  geom_raster(aes(fill = draw)) +
  facet_grid(~ treat + sex) +
  scale_fill_distiller(palette = "Spectral", direction = -1) +
  labs(x = "Age",
       y = "Body mass index",
       fill = "Number of adverse events") +
  theme_tufte() +
  theme(legend.position = "bottom")
```

```{r, echo=FALSE, fig.height=7, fig.width=9}
p
```


Age and BMI were determined as risk factors for CD symptoms worsening. In addition, we can observe an increased risk of suffering an adverse event when we go from **prednisone** to **sulfasalazine**, or even more to **placebo**. Nonetheless, in this type of plots it's not possible to visualize the uncertainty associated to each estimate. Thus, let's plot treatment effectiveness using densities.

```{r, echo=FALSE}
p_2 <- pred %>%
  
  # a bit of data wrangling
  filter(draw < 18) %>% # removing potential outliers
  mutate(treat = case_when(
    treat == "placebo" ~ "Placebo",
    treat == "d1" ~ "Prednisone",
    treat == "d2" ~ "Sulfasalazine"
  ), # treatments' names customization
  treat = factor(treat,
                 levels = c("Prednisone",
                                   "Sulfasalazine",
                                   "Placebo")),
  sex = ifelse(sex == "F", "Females", "Males")) %>%
  
  # plot!
  ggplot(aes(x = treat, y = draw, fill = sex)) +
  stat_slab(side = "left", 
            scale = 0.5, 
            position = "dodge") +
  stat_dotsinterval(scale = 0.5, 
                    quantiles = 100, 
                    position = "dodge") +
  stat_pointinterval(.width = 0.5, 
                     position = position_dodge(width = 1),
                     size = 3.5) +
  labs(x = "",
       y = "Number of adverse events",
       fill = "Sex",
       title = "The National Cooperative Crohn's Disease Study (NCCDS)",
       subtitle = "Data from 117 patients") +
  theme_minimal_hgrid() +
  ggsci::scale_fill_aaas() +
  theme(legend.position = "bottom")
```

```{r, echo=FALSE, fig.height=7, fig.width=9}
p_2
```


In this way, from these results we can conclude that (1) females have fewer adverse events associated than males, and (2) that **prednisone** have associated fewer adverse events than the rest of comparators as we observed in the previous plot. 


### **BONUS**: tips to model different types of adverse events data

The **likelihood** you'll use for modelling adverse event data will be highly dependent on the form this data was collected:

  + **Binary** outcome (e.g., whether an event occurred or not): *Bernoulli* family.
  + **Count** data (e.g., number of adverse events experienced): *Poisson* or *negative binomial* (for overdispersed data).
  + **Time-to-event** data (e.g., time until an adverse event occurs): *Weibull*, *exponential*, *lognormal*,...
  + **Ordinal** data (e.g., severity of adverse events: mild, moderate, severe): *cumulative*, *acat*, *sratio*,...
  + **Proportion** data (e.g., proportion of subjects with adverse events): *binomial*.
  
  
```{r}
sessionInfo()
```

